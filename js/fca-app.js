// Generated by IcedCoffeeScript 1.7.1-a
(function() {
  var App, AttributesForm, ExampleAdd, ExampleRow, ExamplesHeading, ExamplesTable, LinkedState, R, RC, RulesList, br, button, caption, delay, div, form, hideIf, input, label, li, manualRelation, p, small, table, tbody, td, th, thead, tr, ul, _ref;

  R = React;

  RC = R.createClass;

  LinkedState = R.addons.LinkedStateMixin;

  _ref = R.DOM, div = _ref.div, ul = _ref.ul, li = _ref.li, p = _ref.p, small = _ref.small, br = _ref.br, table = _ref.table, caption = _ref.caption, thead = _ref.thead, tbody = _ref.tbody, tr = _ref.tr, th = _ref.th, td = _ref.td, form = _ref.form, label = _ref.label, input = _ref.input, button = _ref.button;

  delay = function(ms, callback) {
    return setTimeout(callback, ms);
  };

  AttributesForm = RC({
    render: function() {
      return form({
        onSubmit: this.props.onSubmit
      }, [
        label({}, 'Перечислите свойства через "|": '), input({
          ref: 'input',
          onChange: this.onChange,
          style: {
            width: '70%'
          },
          autoFocus: true
        })
      ]);
    },
    onChange: function(e) {
      return this.props.onAttributesChange(e.target.value);
    },
    focus: function() {
      return this.refs['input'].getDOMNode().focus();
    }
  });

  ExamplesHeading = RC({
    render: function() {
      var cells;
      cells = this.props.attributes.map(function(attr) {
        return th({}, attr);
      });
      return tr({}, th({}, 'Пример'), cells);
    }
  });

  ExampleRow = RC({
    render: function() {
      var cells;
      cells = this.props.example.vals.map((function(_this) {
        return function(val, i) {
          return td({}, input({
            ref: i,
            onChange: _this.onChange,
            type: 'checkbox',
            checked: val
          }));
        };
      })(this));
      return tr({}, [
        td({}, this.props.example.name), cells, td({}, button({
          onClick: this.onDelete,
          title: 'Удалить'
        }, '−'))
      ]);
    },
    onChange: function(e) {
      var i;
      return this.props.onChangeExample({
        name: this.props.example.name,
        vals: (function() {
          var _i, _ref1, _results;
          _results = [];
          for (i = _i = 0, _ref1 = this.props.example.vals.length; 0 <= _ref1 ? _i < _ref1 : _i > _ref1; i = 0 <= _ref1 ? ++_i : --_i) {
            _results.push(this.refs[i].getDOMNode().checked);
          }
          return _results;
        }).call(this)
      });
    },
    onDelete: function(e) {
      return this.props.onDeleteExample(this.props.example.name);
    }
  });

  ExampleAdd = RC({
    render: function() {
      var cells;
      cells = _(this.props.length).times((function(_this) {
        return function(i) {
          return td({}, input({
            ref: i,
            type: 'checkbox',
            onKeyUp: _this.checkboxKeyUp
          }));
        };
      })(this));
      return tr({
        onKeyPress: this.keyPress,
        onKeyUp: this.keyUp
      }, [
        td({}, input({
          ref: 'name'
        })), cells, td({}, button({
          onClick: this.add,
          title: 'Добавить'
        }, '+'))
      ]);
    },
    focus: function() {
      var i, _i, _ref1;
      for (i = _i = 0, _ref1 = this.props.length; 0 <= _ref1 ? _i < _ref1 : _i > _ref1; i = 0 <= _ref1 ? ++_i : --_i) {
        this.refs[i].getDOMNode().checked = false;
      }
      this.refs['name'].getDOMNode().value = '';
      return this.refs['name'].getDOMNode().focus();
    },
    keyPress: function(e) {
      if (e.keyCode === 13) {
        this.add();
        return e.preventDefault();
      }
    },
    keyUp: function(e) {
      if (e.keyCode === 27) {
        return this.props.onCancel();
      }
    },
    checkboxKeyUp: function(e) {
      var i, node, _ref1;
      if ((48 <= (_ref1 = e.keyCode) && _ref1 <= 57)) {
        i = (e.keyCode + 1) % 10;
        node = this.refs[i].getDOMNode();
        return node.checked = !node.checked;
      }
    },
    add: function() {
      var i;
      this.props.onUpsertExample({
        name: this.refs['name'].getDOMNode().value,
        vals: (function() {
          var _i, _ref1, _results;
          _results = [];
          for (i = _i = 0, _ref1 = this.props.length; 0 <= _ref1 ? _i < _ref1 : _i > _ref1; i = 0 <= _ref1 ? ++_i : --_i) {
            _results.push(this.refs[i].getDOMNode().checked);
          }
          return _results;
        }).call(this)
      });
      return this.focus();
    }
  });

  hideIf = function(cond, props) {
    if (cond) {
      if (props == null) {
        props = {};
      }
      if (props.style == null) {
        props.style = {};
      }
      props.style.display = 'none';
    }
    return props;
  };

  ExamplesTable = RC({
    render: function() {
      var rows;
      rows = this.props.examples.map((function(_this) {
        return function(example, i) {
          return ExampleRow({
            onChangeExample: _this.props.onUpsertExample,
            onDeleteExample: _this.props.onDeleteExample,
            example: example
          });
        };
      })(this));
      return div(hideIf(!this.props.attributes.length), [
        p({}, ['Добавляйте примеры, пока все выводы не будут истинны.', br({}), small({}, 'Предпосылка: все заключения от наличия одного набора свойств к наличию другого истинны, если не показано обратное.')]), table({}, [
          thead({}, ExamplesHeading({
            attributes: this.props.attributes
          })), tbody({}, [
            rows, ExampleAdd({
              ref: 'exampleAdd',
              onUpsertExample: this.props.onUpsertExample,
              onCancel: this.props.onCancel,
              length: this.props.attributes.length
            })
          ])
        ])
      ]);
    },
    focusAddExample: function() {
      return this.refs.exampleAdd.focus();
    }
  });

  RulesList = RC({
    render: function() {
      var items;
      items = this.props.rules.map(function(_arg) {
        var from, to;
        from = _arg[0], to = _arg[1];
        return li({}, from.length ? "если " + from + ", то " + to : "всегда " + to);
      });
      return div(hideIf(!this.props.show), [
        p({}, ['Выводы ', br({}), small({}, 'из предпосылки, ограниченной примерами')]), items.length ? ul({}, items) : p({
          style: {
            'font-style': 'italic'
          }
        }, ['Больше ничего вывести нельзя.'])
      ]);
    }
  });

  manualRelation = function() {
    var cache;
    cache = {};
    return function(g1, m1) {
      var rel;
      cache[g1] = cache[g1] || {};
      rel = cache[g1][m1];
      if (rel != null) {
        return rel;
      } else {
        return cache[g1][m1] = confirm("" + g1 + " — " + m1 + "?");
      }
    };
  };

  App = RC({
    render: function() {
      return div({}, [
        AttributesForm({
          ref: 'attributesForm',
          onAttributesChange: this.attributesChanged,
          onSubmit: this.focusAddExample
        }), ExamplesTable({
          ref: 'examplesTable',
          onUpsertExample: this.onUpsertExample,
          onDeleteExample: this.onDeleteExample,
          onCancel: this.focusAttributesForm,
          attributes: this.state.attributes,
          examples: this.state.examples
        }), RulesList({
          rules: this.state.rules,
          show: this.state.attributes.length
        })
      ]);
    },
    getInitialState: function() {
      this.model = {
        attributes: [],
        examples: []
      };
      return _.extend({
        rules: []
      }, this.model);
    },
    attributesChanged: function(attributes) {
      var cur, next;
      cur = this.model.attributes;
      next = _.chain(attributes.split('|')).map(function(s) {
        return s.trim();
      }).without('').uniq().value();
      if (!_.isEqual(cur, next)) {
        this.model.attributes = next;
        if (cur.length !== next.length) {
          this.model.examples = [];
        }
        this.setState(this.model);
        return this.autoexplore();
      }
    },
    focusAddExample: function() {
      this.refs['examplesTable'].focusAddExample();
      return false;
    },
    focusAttributesForm: function() {
      return this.refs['attributesForm'].focus();
    },
    onUpsertExample: function(example) {
      var old;
      old = _.find(this.model.examples, function(x) {
        return x.name === example.name;
      });
      if (old) {
        old.vals = example.vals;
      } else {
        this.model.examples.push(example);
      }
      this.setState(this.model);
      return this.autoexplore();
    },
    onDeleteExample: function(name) {
      var i, x, _i, _len, _ref1, _results;
      _ref1 = this.model.examples;
      _results = [];
      for (i = _i = 0, _len = _ref1.length; _i < _len; i = ++_i) {
        x = _ref1[i];
        if (x.name === name) {
          this.model.examples.splice(i, 1);
          this.setState(this.model);
          this.autoexplore();
          break;
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    },
    autoexplore: function() {
      var attrIndices;
      attrIndices = _.invert(_.extend({}, this.model.attributes));
      return this.setState({
        rules: fca.autoexplore(this.model.examples, this.model.attributes, function(g, m) {
          return g.vals[attrIndices[m]];
        })
      });
    }
  });

  R.renderComponent(App(), document.body);

}).call(this);
